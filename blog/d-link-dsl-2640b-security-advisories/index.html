<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<title>Security Advisories: D-Link DSL-2640B</title>

	<!-- mobile responsive meta -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="description" content="Raelize provides top-notch embedded device security serrvices like consultancy, testing, research and training.">
	
	<meta name="author" content="Raelize B.V.">
	<meta name="generator" content="Hugo 0.145.0">

	<!-- plugins -->
	
	<link rel="stylesheet" href="https://raelize.com/plugins/bootstrap/bootstrap.min.css">
	
	<link rel="stylesheet" href="https://raelize.com/plugins/themify-icons/themify-icons.css">
	
	<link rel="stylesheet" href="https://raelize.com/plugins/magnific-popup/magnific-popup.css">
	
	<link rel="stylesheet" href="https://raelize.com/plugins/slick/slick.css">
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Anaheim%7cQuattrocento&#43;Sans:400,700&amp;display=swap">
	

	<!-- Main Stylesheet -->
	
	<link rel="stylesheet" href="https://raelize.com/css/style.min.css" media="screen">

	<!-- Custom stylesheet - for your changes -->
	
  <link rel="stylesheet" href="https://raelize.com/css/custom.min.css" media="screen">

	<!--Favicon-->
	<link rel="shortcut icon" href="https://raelize.com/images/Uk3Fdpje_400x400.jpg" type="image/x-icon">
	<link rel="icon" href="https://raelize.com/images/Uk3Fdpje_400x400.jpg" type="image/x-icon">

	
	<!-- Global Site Tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135892271-3"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-135892271-3');
	</script>
	

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>


<body id="body" data-spy="scroll" data-target=".navbar" data-offset="55">
  <div id="content">
    


<section class="sticky-top navigation">
	<div class="container">
		<nav class="navbar navbar-expand-lg navbar-dark">
			<a class="navbar-brand p-0" href="/">
				
				<img class="lozad" data-src="https://raelize.com/images/logo.png" alt="Raelize - Embedded Device Security Services Consultancy Testing Research Training" height="42">
				
			</a>

			<button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navigation">
				<ul class="navbar-nav ml-auto">
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/about">about</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/#services">overview</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/training">training</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/consultancy">consultancy</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/testing">testing</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/publications">publications</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/blog">blog</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/resources">resources</a>
					</li>
					
					<li class="nav-item">
            <a class="nav-link" href="https://raelize.com/#contact">contact</a>
					</li>
					
				</ul>
				
			</div>
		</nav>
	</div>
</section>


<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 offset-lg-2 text-center">
        <hr>
        <h1>Security Advisories: D-Link DSL-2640B</h1>
        <p>Saturday, Mar 28, 2020</p>
        <hr>
        
      </div>
      <div class="col-lg-8 offset-lg-2">
        <div class="post-single-content" background-color=0xff>
          <p>In a <a href="/posts/security-impact-of-eol-devices/">previous post</a> we shared our considerations on the impact of vulnerabilities in Internet connected devices that are <a href="https://en.wikipedia.org/wiki/End-of-life_%28product%29">EoL</a>. We used the vulnerabilities that we identified in the <a href="https://eu.dlink.com/uk/en/products/dsl-2640b-adsl-2-wireless-g-router-with-4-port-10-100-switch">D-Link DSL-2640B DSL gateway</a> as a use case to support our considerations. In this post we describe the technical details of these vulnerabilities.</p>
<p>Before we dive into the technical details, it's important to note that:</p>
<ul>
<li>all vulnerabilities are (at least) applicable to the D-Link DSL-2640B (HW revision B2, Firmware version: EU_4.01B)</li>
<li>all vulnerabilities apply to the latest available firmware (as of 27/03/2020)</li>
<li>all vulnerabilities have been reported to D-Link</li>
<li>we are not aware of any security fix released by D-Link</li>
<li>as the device is EoL, following D-Link's policy, no fix may ever be available</li>
</ul>
<p>The vulnerabilities described in this post may apply to other hardware revisions, other firmware versions and even completely different models. We did not investigate this further and D-Link did not provide any additional insights.</p>
<p>The following vulnerabilities are described in this post:</p>
<ul>
<li><a href="/blog/d-link-dsl-2640b-security-advisories/#cve-2020-9275----d-link-dsl-2640b---remote-credentials-exfiltration">CVE-2020-9275 &ndash; D-Link DSL-2640B - Remote credentials exfiltration</a></li>
<li><a href="/blog/d-link-dsl-2640b-security-advisories/#cve-2020-9279----d-link-dsl-2640b---hard-coded-privileged-account">CVE-2020-9279 &ndash; D-Link DSL-2640B - Hard-coded privileged account</a></li>
<li><a href="/blog/d-link-dsl-2640b-security-advisories/#cve-2020-9278----d-link-dsl-2640b---unauthenticated-configuration-reset">CVE-2020-9278 &ndash; D-Link DSL-2640B - Unauthenticated configuration reset</a></li>
<li><a href="/blog/d-link-dsl-2640b-security-advisories/#cve-2020-9277----d-link-dsl-2640b---cgi-authentication-bypass">CVE-2020-9277 &ndash; D-Link DSL-2640B - CGI Authentication bypass</a></li>
<li><a href="/blog/d-link-dsl-2640b-security-advisories/#cve-2020-9276----d-link-dsl-2640b---do_cgi-buffer-overflow">CVE-2020-9276 &ndash; D-Link DSL-2640B - do_cgi buffer overflow</a></li>
</ul>
<p>We hope we provided sufficient technical details of the identified vulnerabilities. Additional information (e.g. video demonstrations) may be provided in the future.</p>
<p>We hope you enjoy the technical remainder of this post! :)</p>
<h5 id="cve-2020-9275--d-link-dsl-2640b---remote-credentials-exfiltration">CVE-2020-9275 &ndash; D-Link DSL-2640B - Remote credentials exfiltration</h5>
<p>This <a href="/advisories/CVE-2020-9275_D-Link-DSL-2640B_Remote-Credentials-Exfiltration_v1.0.txt">vulnerability</a> allows retrieval of the administrative password by sending a specific UDP packet to port 65002 of the device.</p>
<p>An attacker connected to the WiFi or the local LAN, or who is able to reach the internal device interface in any other way, can retrieve the device password with a single <code>UDP</code> request.</p>
<p>Most functionality of the device, including the administration panel and the web server, are implemented in a single process named <code>cfm</code> executed at startup. The <code>cfm</code> process listens on <code>UDP</code> port <code>65002</code>. Likely to support device configuration from a dedicated application. The screenshot below, shows the function implementing the communication protocol. The function name, <code>pcApplication</code>, is taken directly from the binary's symbols.</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/UDP_65002_pcApplication_cfm.png" style="max-width: 100%; width: 600px"></p>
<p>Communication is done using D-Link's proprietrary protocol for which no information is publicly available. Reversing the <code>cfm</code> binary yields the following structure for the protocol packet.</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/cfm_protocol.png" style="max-width: 100%; width: 600px"></p>
<p>Several commands are supported and accessible by specifying the command code in the 2 bytes <code>cmd</code> field. Communication is in plaintext and without authentication. The code only checks, for some commands, that the provided <code>MAC</code> address matches the device <code>MAC</code> address.</p>
<p>The command <code>\x00\x01</code> allows retrieving system information from the device, including the device administrative password which is returned in plaintext. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>python <span style="color:#f92672">-</span>c <span style="color:#e6db74">&#39;print(&#34;</span><span style="color:#ae81ff">\x00\x01</span><span style="color:#e6db74">&#34;* 5)&#39;</span> <span style="color:#f92672">|</span> nc <span style="color:#f92672">-</span>u <span style="color:#ae81ff">192.168.1.1</span> <span style="color:#ae81ff">65002</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####MAC_ADDRESS####&lt;boardID=D-4P-W&gt;&lt;sysVersion=EU_3-10-02-3B00.A2pB022g2.d20h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>sysModel<span style="color:#f92672">=</span>DSL<span style="color:#f92672">-</span><span style="color:#ae81ff">2640</span>B<span style="color:#f92672">&gt;&lt;</span>local_username<span style="color:#f92672">=</span>admin<span style="color:#f92672">&gt;&lt;</span>local_password<span style="color:#f92672">=</span>password<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>local_ipaddress<span style="color:#f92672">=</span><span style="color:#ae81ff">192.168.1.1</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>The MAC address check mentioned earlier is not performed for the  <code>\x00\x01</code> command. Any additional bytes are  completely ignored which allowed us to identify the vulnerability in a very trivial manner.</p>
<p>In fact, we found this vulnerability using a rather dumb fuzzing campaign. To start, we simply piped <code>/dev/urandom</code> into <code>UDP</code> port <code>65002</code>. Obviously, we did not think this approach would yield vulnerabilities in any way. Especially because no traffic monitoring, no payload selection and no target debugging were in place. However, surprisingly, the device kindly returned the administrative password within a few minutes&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>time cat /dev/urandom | nc -u 192.168.1.1 <span style="color:#ae81ff">65002</span>
</span></span><span style="display:flex;"><span>&amp;ZLM���&lt;boardID<span style="color:#f92672">=</span>D-4P-W&gt;&lt;sysVersion<span style="color:#f92672">=</span>EU_3-10-02-3B00.A2pB022g2.d20h&gt;
</span></span><span style="display:flex;"><span>&lt;sysModel<span style="color:#f92672">=</span>DSL-2640B&gt;&lt;local_username<span style="color:#f92672">=</span>admin&gt;&lt;local_password<span style="color:#f92672">=</span>a&gt;
</span></span><span style="display:flex;"><span>&lt;local_ipaddress<span style="color:#f92672">=</span>192.168.1.1&gt;^C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    2m53.240s
</span></span><span style="display:flex;"><span>user    0m0.599s
</span></span><span style="display:flex;"><span>sys 0m21.439s
</span></span></code></pre></div><p>Due of the (very) forgiving implementation, any <code>UDP</code> packet with <code>\x00\x01</code> at the right location would return the administrative password. Even our initial dumb approach yielded the administrative password within minutes.</p>
<p>Our initial test identified the vulnerability is exploitable from the LAN. Nonetheless, the service seems to be listening on all the interfaces (see below).</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/cfm_socket.png" style="max-width: 100%; width: 600px"></p>
<p>Unfortunately, we were unable to verify the vulnerability on the WAN side as we lacked a suitable DSL connection. Using the information we have, we cannot exclude that the vulnerability is also exploitable on WAN side. Of course, we would be happy to hear more insight on this.</p>
<h5 id="cve-2020-9279--d-link-dsl-2640b---hard-coded-privileged-account">CVE-2020-9279 &ndash; D-Link DSL-2640B - Hard-coded privileged account</h5>
<p>For this <a href="/advisories/CVE-2020-9279_D-Link-DSL-2640B_Hard-coded-privileged-account_v1.0.txt">vulnerability</a> we identified is a hard-coded user account. An attacker may use these credentials to login into the device in order to perform administrative tasks.</p>
<p>The vulnerability was identified by analyzing the authentication process accessible via the web interface. While the <code>cfm</code> process provides the communication &quot;plumbing&quot;, the actual authentication is delegated to an external library <code>libpsi.so</code>. The library uses an object-oriented approach for handling the authentication credentials and the incoming authentication requests.</p>
<p>An analysis of the <code>cfm</code> process revealed a code path supporting authentication for the user named <code>user</code>.</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/user_user.png" style="max-width: 100%; width: 600px"></p>
<p>The <code>default</code> passwords used for authentication are hard-coded in the <code>libpsi.so</code> binary.</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/user_account.png" style="max-width: 100%; width: 600px"></p>
<p>Reverse engineering this library told us that the following <code>default</code> credentials can be used for logging into the web interface of the device.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Username: user
</span></span><span style="display:flex;"><span>Password: 00202b004720
</span></span></code></pre></div><p>Although the password of the user <code>user</code> can be changed, no web interface control is provided for modifying it. Therefore, this password will be set to its default state for the entire life time of the device. It is important to note that the account is valid for authenticating to any service relying on <code>lipsi.so</code>, such as <code>ftp</code>, <code>telnet</code> and <code>ssh</code>. As far as we know, the user <code>user</code> has similar capabilities as the <code>admin</code> account.</p>
<p>Interestingly, even though <code>libpsi.so</code> is only released in binary format, the credentials are clearly visible in the GPL source code of the device (see picture below).</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/user_pwd_src.png" style="max-width: 100%; width: 600px"></p>
<p>Also, interestingly, these credentials are referred to as <code>ASUS_USER_ACCOUNT</code>. One may wonder how an ASUS related account ends up in a D-Link device.</p>
<p>The source code itself does not reveal any intention of obfuscation. The credentials seem to be valid for other ASUS devices as well. ASUS refers to them as the <code>ASUS Super account</code> in some old pages.</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/asus_account.png" style="max-width: 100%; width: 600px"></p>
<p>One could say that it's basically an ASUS <code>feature</code> ( :-) ) which ended up for some unknown reason in a D-Link device. The supply chain of IoT devices are definitely not devoid any mysteries. We believe it may be the result of some &quot;supply chain magic&quot; rather than malicious intent.</p>
<p>The last remark we would like to make is that this vulnerability may be exploited through browser pivoting. A malicious website, visited with any device connected to the WiFi/LAN, may perform crafted requests towards the gateway.</p>
<h5 id="cve-2020-9278--d-link-dsl-2640b---unauthenticated-configuration-reset">CVE-2020-9278 &ndash; D-Link DSL-2640B - Unauthenticated configuration reset</h5>
<p>This <a href="/advisories/CVE-2020-9278_D-Link-DSL-2640B_Unauthenticated-configuration-reset_v1.0.txt">vulnerability</a> allows an attacker to reset the device to its default configuration by accessing a specific URL. No authentication is required.</p>
<p>In fact, the following URLs can be accessed without authentication.</p>
<ul>
<li>rebootinfo.cgi</li>
<li>ppppasswordinfo.cgi</li>
<li>qosqueue.cmd?action=savReboot</li>
<li>restoreinfo.cgi</li>
</ul>
<p>Specifically, the device can be reset to default factory configuration by simply requesting the following URL:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>http://&lt;device_IP_address&gt;/restoreinfo.cgi 
</span></span></code></pre></div><p>An attacker may reset the administrative password to its default value <code>admin</code>, log in and perform any administrative tasks on the device, such as upload of malicious firmware or configuration of malicious DNS servers.</p>
<p>While the exploitation of this vulnerability requires access to the device LAN interface, it can also be remotely exploited via browser pivoting. An attacker in control of a malicious website may blindly reset the configuration of the device and, under some conditions, take full control of the device.</p>
<h5 id="cve-2020-9277--d-link-dsl-2640b---cgi-authentication-bypass">CVE-2020-9277 &ndash; D-Link DSL-2640B - CGI Authentication bypass</h5>
<p>The CVE-2020-9277 <a href="/advisories/CVE-2020-9277_D-Link-DSL-2640B_CGI-Authentication-bypass_v1.0.txt">vulnerability</a> allows bypassing the authentication process for authenticated resources. An attacker may be able to directly access administrative functions of the web interface, without the need to supply valid credentials.</p>
<p>The web server first identifies (1) whether the requested <code>URL</code> requires authentication. The check is carried on by analyzing the requested file extension, located at the <code>end</code> of an <code>URL</code>. For instance, accessing administrative <code>cgi</code> modules requires authentication. The authentication is not performed immediately but delayed at a later point in the code.</p>
<p>The code then identifies (2) special resources for which the authentication is not necessary. Examples are images or <code>Javascript</code> utilities. The code matches the <code>start</code> of an <code>URL</code> with the specific string (e.g: <code>/images/</code>, <code>utils.js</code>) using the <code>strncmp()</code> function. If a match is found, no authentication is  performed, regardless of  the outcome of (1). The request is then further processed as it had been successfully authenticated.</p>
<p>Finally, if a <code>cgi</code> module is requested, the <code>do_cgi()</code> function determines (3) the module to be executed by searching the module name <code>anywhere</code> in the <code>URL</code>, using the <coed>strstr()</coed> function.</p>
<p>All the above checks act in isolation, no state is carried over. An attacker can then craft malicious URLs for bypassing authentication for <code>cgi</code> modules. The attack URL below changes the device admin password to <em>newpass</em> without any need for authentication:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Original URL: http://&lt;device_IP_address&gt;/redpass.cgi?sysPassword=newpass
</span></span><span style="display:flex;"><span>Attack URL: http://&lt;device_IP_address&gt;/images/redpass.cgi?sysPassword=newpass
</span></span></code></pre></div><p>This vulnerability gives an attacker full device control and allows performing unauthenticated administrative functions. This vulnerability requires accessing the device LAN interface, but it is suitable for exploitation via browser pivoting, allowing for remote attacks over the Internet.</p>
<h5 id="cve-2020-9276--d-link-dsl-2640b---do_cgi-buffer-overflow">CVE-2020-9276 &ndash; D-Link DSL-2640B - do_cgi buffer overflow</h5>
<p>This <a href="/advisories/CVE-2020-9276_D-Link-DSL-2640B_do_cgi-buffer-overflow_v1.0.txt">vulnerability</a> is a buffer overflow occurring in the <code>do_cgi()</code> function, while parsing the requested <code>cgi</code> module name. An attacker may execute arbitrary code on the device with administrative privileges, by supplying a malicious <code>cgi</code> module name in the URL.</p>
<p>The <code>do_cgi</code> function, in order to identify the module to be executed, copies the module name on the stack. However, it does not check whether the length of the supplied module name fits in the allocated buffer (see picture).</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/do_cgi_bof.png" style="max-width: 100%; width: 600px"></p>
<p>A long <code>cgi</code> module name will overwrite the return address saved on the stack, allowing for a classical stack buffer overflow which is easy to exploit.</p>
<p>The <code>do_cgi()</code> function can, in principle, only be accessed after authentication. However, unauthenticated exploitation of this vulnerability is possible by combining it with <a href="/blog/d-link-dsl-2640b-security-advisories/#cve-2020-9277----d-link-dsl-2640b---cgi-authentication-bypass">CVE-2020-9277</a>. In the picture below we exploit this vulnerability without authentication, execute a reverse shell payload.</p>
<p style="text-align:center;"><img src="/img/2020-02-D-Link-CVEs/exploited_b0f.png" style="max-width: 100%; width: 600px"></p>
<p>While the vulnerability is potentially exploitable via browser pivoting, exploitation may not be trivial due to the URL mangling introduced by the browser when applying URL encoding on the outgoing requests.</p>

        </div>
        
        
        

      </div>
    </div>
  </div>
</section>


  </div><!-- end Contact Area -->
<footer id="footer" class="section-bg">
	<div class="container">
		<div class="row wow fadeInUp" data-wow-duration="500ms">
			<div class="col-xl-12">

				<!-- Footer Social Links -->
				<div class="social-icon">
					<ul class="list-inline">
						
						<li class="list-inline-item"><a href="https://twitter.com/raelizecom" rel="nofollow"><i class="ti-twitter-alt"></i></a></li>
						
						<li class="list-inline-item"><a href="https://www.linkedin.com/company/raelize" rel="nofollow"><i class="ti-linkedin"></i></a></li>
						
					</ul>
				</div>

				<!-- copyright -->
				<div class="copyright text-center">
					<a href="https://raelize.com/">
						<img src="https://raelize.com/images/logo.png" alt="Raelize - Embedded Device Security Services Consultancy Testing Research Training" height="42" />
					</a>
					<br>
					<p>Copyright ©2020 Raelize B.V. <br> Powered by <a href=#>Hugo</a> and <a href="https://themefisher.com">Themefisher</a>.</p>
				</div>
			</div>
		</div>
	</div>
</footer>
<!-- /footer -->

<!-- Google Map API -->


<!-- JS Plugins -->

<script src="https://raelize.com/plugins/jquery/jquery.min.js"></script>

<script src="https://raelize.com/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://raelize.com/plugins/slick/slick.min.js"></script>

<script src="https://raelize.com/plugins/shuffle/shuffle.min.js"></script>

<script src="https://raelize.com/plugins/magnific-popup/jquery.magnific-popup.min.js"></script>

<script src="https://raelize.com/plugins/lazy-load/lozad.min.js"></script>

<script src="https://raelize.com/plugins/google-map/map.js"></script>


<!-- Main Script -->

<script src="https://raelize.com/js/script.min.117f25fdd69809937e03f47113cbf673f49c2074d65da15ea1d385ad742d92a49ed5dd2000a4585ecfdebda6feb7ef54.js" integrity="sha384-EX8l/daYCZN&#43;A/RxE8v2c/ScIHTWXaFeodOFrXQtkqSe1d0gAKRYXs/evab&#43;t&#43;9U"></script>


</body>

</html>
